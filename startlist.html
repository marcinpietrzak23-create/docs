<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Listy startowe</title>

<link rel="stylesheet" href="style.css">

<style>
.tabs {
  margin-bottom: 14px;
}

.tabs button {
  padding: 8px 12px;
  margin: 4px;
  cursor: pointer;
}

.startlist-actions {
  margin-bottom: 12px;
}

table {
  border-collapse: collapse;
  width: 100%;
  background: white;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

@media print {
  header,
  .tabs,
  .startlist-actions {
    display: none;
  }

  body {
    background: white;
  }

  table {
    font-size: 12px;
  }
}
</style>
</head>

<body class="startlist-page">

<header class="site-header">
  <div class="header-inner">
    <div class="header-title">
      Hardstyle Kettlebell European Championship
    </div>
    <div class="header-links">
      <a href="index.html">Wyniki</a>
      <a href="#" onclick="window.print()">Drukuj</a>
    </div>
  </div>
</header>

<div class="page">
  <div class="panel">

    <h1>Listy startowe</h1>

    <div class="tabs" id="tabs"></div>

    <div class="startlist-actions">
      <button onclick="window.print()">Drukuj</button>
      <button onclick="exportPDF()">PDF</button>
    </div>

    <div id="content"></div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbyWhUsE8mxQeGs2LBGN3lWTVvIrqGtvoGX61z61QPilUpOXT6vImh1gg9z1IPQ18kvmhg/exec?api=startlist";

let grouped = {};

init();

async function init() {
  const res = await fetch(API_URL);
  const data = await res.json();

  grouped = groupByCategory(data);
  renderTabs();
  showFirst();
}

function groupByCategory(rows) {
  const g = {};
  rows.forEach(r => {
    if (!g[r.kategoria]) g[r.kategoria] = [];
    g[r.kategoria].push(r);
  });
  return g;
}

function renderTabs() {
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";

  Object.keys(grouped).forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.onclick = () => renderTable(cat);
    tabs.appendChild(btn);
  });
}

function showFirst() {
  const first = Object.keys(grouped)[0];
  if (first) renderTable(first);
}

function renderTable(category) {

  const rows = [...grouped[category]];

  rows.sort((a, b) =>
    (a.zawodnik || "").localeCompare(b.zawodnik || "", "pl")
  );

  const container = document.getElementById("content");

  let html = `
    <h2>${category}</h2>
    <table>
      <tr>
        <th>LP</th>
        <th>Zawodnik</th>
        <th>Klub</th>
        <th>Kategoria dodatkowa</th>
        <th>Waga</th>
      </tr>
  `;

  rows.forEach((r, i) => {
    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${r.zawodnik || ""}</td>
        <td>${r.klub || ""}</td>
        <td>${r.kategoria_dodatkowa || ""}</td>
        <td>
  <input
    type="number"
    value="${r.waga || ""}"
    style="width:70px"
    onchange="saveWeight('${r.zawodnik}', this.value)"
  >
</td>
      </tr>
    `;
  });

  html += "</table>";
  container.innerHTML = html;
}

function exportPDF() {

  const element = document.getElementById("content");
  const category = document.querySelector("#content h2")?.textContent || "lista-startowa";

  html2pdf()
    .set({
      margin: [5, 5, 5, 5],
      filename: category.replace(/\s+/g, "_") + ".pdf",
      pagebreak: { mode: ["css", "legacy"] },
      html2canvas: {
        scale: 2,
        scrollY: 0
      },
      jsPDF: {
        unit: "mm",
        format: "a4",
        orientation: "landscape"
      }
    })
    .from(element)
    .save();
}
function saveWeight(zawodnik, waga) {

  fetch(
    "https://script.google.com/macros/s/AKfycbyWhUsE8mxQeGs2LBGN3lWTVvIrqGtvoGX61z61QPilUpOXT6vImh1gg9z1IPQ18kvmhg/exec" +
    `?api=saveWeight&zawodnik=${encodeURIComponent(zawodnik)}&waga=${waga}`
  );
}


</script>

</body>
</html>
