<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Klasyfikacja</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
#loader {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 40vh;
  font-size: 18px;
  color: #666;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #ddd;
  border-top: 4px solid #c00;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 12px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>

<body>

<header class="site-header">
  <div class="header-inner">
    <div class="header-title">
      Hardstyle Kettlebell European Championship
    </div>
    <div class="header-links">
      <a id="liveLink" href="#" target="_blank" style="display:none">üî¥ LIVE</a>
      <a href="kontakt.html">Kontakt</a>
    </div>
  </div>
</header>

<div class="page table-page">
  <div class="table-panel">

    <a href="index.html">‚Üê Powr√≥t</a>
    <h1 id="categoryTitle"></h1>

    <input id="filterInput" placeholder="Filtruj po zawodniku lub klubie‚Ä¶" />

    <div id="loader">
      <div class="spinner"></div>
      <div>≈Åadowanie wynik√≥w‚Ä¶</div>
    </div>

    <div id="content" style="display:none">

      <h2>üèÜ Klasyfikacja generalna</h2>
      <table id="generalka">
        <thead><tr></tr></thead>
        <tbody></tbody>
      </table>

      <div id="boje"></div>

    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyWhUsE8mxQeGs2LBGN3lWTVvIrqGtvoGX61z61QPilUpOXT6vImh1gg9z1IPQ18kvmhg/exec";
const params = new URLSearchParams(location.search);
const CATEGORY = decodeURIComponent(params.get("arkusz") || "");
document.getElementById("categoryTitle").textContent = CATEGORY;

/* ================= HELPERS ================= */
function norm(s){
  return String(s||"")
    .replace(/\u00A0/g," ")
    .trim()
    .replace(/\s+/g," ")
    .toLowerCase();
}

/* ================= SETTINGS ‚Äì KOLEJNO≈öƒÜ KONKURENCJI ================= */
let COMP_ORDER = [];

fetch(`${API_URL}?settings=1`)
  .then(r=>r.json())
  .then(res=>{
    const s = res?.settings || {};

    Object.keys(s)
      .map(k => k.trim())
      .filter(k => k.startsWith("competition_"))
      .map(k => ({
        idx: parseInt(k.replace("competition_",""),10),
        key: s[k]
      }))
      .filter(o => o.key)
      .sort((a,b)=>a.idx-b.idx)
      .forEach(o => COMP_ORDER.push(o.key));

    const btn=document.getElementById("liveLink");
    if(s.live_url){
      btn.href=s.live_url;
      btn.textContent=s.live_text||"üî¥ LIVE";
      btn.style.display="inline-block";
    }
  })
  .catch(()=>{});

/* ================= CACHE FIRST ================= */
function getCache(){
  try {
    return {
      view: JSON.parse(localStorage.getItem("api_view")||"null"),
      extra: JSON.parse(localStorage.getItem("api_extra")||"null"),
      boje: JSON.parse(localStorage.getItem("api_boje")||"null")
    };
  } catch {
    return {};
  }
}

function renderAll(baseRes, extraRes, bojeRows){
  const baseRows=(baseRes.data||[]).filter(r=>norm(r.KATEGORIA_PODSTAWOWA||r.KATEGORIA)===norm(CATEGORY));
  const extraRows=(extraRes.data||[]).filter(r=>norm(r.KATEGORIA_DODATKOWA)===norm(CATEGORY));
  buildGeneralka([...baseRows,...extraRows]);

  const filteredBoje=(bojeRows||[]).filter(r =>
    norm(r.kategoria)===norm(CATEGORY) ||
    norm(r.kategoria_dodatkowa)===norm(CATEGORY)
  );

  buildBoje(filteredBoje);
}

/* ===== render z cache ===== */
const cache=getCache();
if(cache.view && cache.extra && cache.boje){
  renderAll(cache.view, cache.extra, cache.boje);
}

/* ===== fetch w tle ===== */
Promise.all([
  fetch(`${API_URL}?arkusz=API_VIEW`).then(r=>r.json()).catch(()=>({data:[]})),
  fetch(`${API_URL}?arkusz=API_DODATKOWE`).then(r=>r.json()).catch(()=>({data:[]})),
  fetch(`${API_URL}?api=boje`).then(r=>r.json()).catch(()=>[])
])
.then(([view,extra,boje])=>{
  localStorage.setItem("api_view",JSON.stringify(view));
  localStorage.setItem("api_extra",JSON.stringify(extra));
  localStorage.setItem("api_boje",JSON.stringify(boje));
  renderAll(view,extra,boje);
})
.finally(()=>{
  document.getElementById("loader").style.display="none";
  document.getElementById("content").style.display="block";
});

/* ================= GENERALKA ================= */
function buildGeneralka(rows){
  if(!rows.length) return;

  const comps = COMP_ORDER.length
    ? COMP_ORDER
    : [...new Set(rows.map(r=>r.KONKURENCJA))];

  const byAth={};

  rows.forEach(r=>{
    if(!byAth[r.ZAWODNIK]){
      byAth[r.ZAWODNIK]={
        name:r.ZAWODNIK,
        klub:r.KLUB||"-",
        waga:r.WAGA||"-",
        sum:r.PKT_SUM,
        pts:{}
      };
    }
    byAth[r.ZAWODNIK].pts[r.KONKURENCJA]=r.PKT;
  });

  document.querySelector("#generalka thead tr").innerHTML=`
    <th>M-ce</th>
    <th>Zawodnik</th>
    <th>Klub</th>
    <th>Waga</th>
    <th>SUMA</th>
    ${comps.map(c=>`<th>${c}</th>`).join("")}
  `;

  const tbody=document.querySelector("#generalka tbody");
  tbody.innerHTML="";

  Object.values(byAth)
    .sort((a,b)=>a.sum-b.sum)
    .forEach((r,i)=>{
      tbody.insertAdjacentHTML("beforeend",`
        <tr>
          <td>${i+1}</td>
          <td>${r.name}</td>
          <td>${r.klub}</td>
          <td>${r.waga}</td>
          <td>${r.sum}</td>
          ${comps.map(c=>`<td>${r.pts[c] ?? "-"}</td>`).join("")}
        </tr>
      `);
    });
}

/* ================= BOJE ‚Äì FINAL ================= */
function buildBoje(rows){
  const box=document.getElementById("boje");
  box.innerHTML="";
  if(!rows.length){
    box.innerHTML="<p>Brak wynik√≥w</p>";
    return;
  }

  // konkurencja ‚Üí zawodnik ‚Üí agregacja
  const byComp = {};
  rows.forEach(r=>{
    if(!byComp[r.konkurencja]) byComp[r.konkurencja]={};

    if(!byComp[r.konkurencja][r.zawodnik]){
      byComp[r.konkurencja][r.zawodnik]={
        zawodnik: r.zawodnik,
        klub: r.klub,
        waga: r.waga,
        proby: [],
        odciezar: r.odciezar,
        powtorzenia: r.powtorzenia,
        wynik: r.wynik
      };
    }

    // tylko STANDARD ma pr√≥by
    if(r.proba){
      byComp[r.konkurencja][r.zawodnik].proby.push({
        nr: r.proba,
        val: r.wynik
      });
    }
  });

  const order = COMP_ORDER.length ? COMP_ORDER : Object.keys(byComp);

  order.forEach(comp=>{
    const athletes = byComp[comp];
    if(!athletes) return;

    const list = Object.values(athletes);

    // SORTOWANIE
    if(/TIEBREAK/i.test(comp)){
      list.sort((a,b)=>a.wynik - b.wynik);
    }
    else if(/SN/i.test(comp)){
      list.sort((a,b)=>b.wynik - a.wynik);
    }
    else {
      list.forEach(a=>{
        const vals = a.proby.map(p=>p.val);
        a.max = Math.max(...vals);
        a.pct = a.waga ? a.max / a.waga : 0;
      });
      list.sort((a,b)=>b.pct - a.pct);
    }

    box.insertAdjacentHTML("beforeend",`<h2>üèãÔ∏è ${comp}</h2>`);

    let html=`<table><thead><tr>
      <th>M-ce</th>
      <th>Zawodnik</th>
      <th>Klub</th>
      <th>Waga</th>`;

    if(/TIEBREAK/i.test(comp)){
      html+=`<th>Punkty</th>`;
    }
    else if(/SN/i.test(comp)){
      html+=`<th>Odwa≈ºnik</th><th>Powt.</th><th>Wynik</th>`;
    }
    else {
      html+=`<th>Pr√≥ba 1</th><th>Pr√≥ba 2</th><th>Pr√≥ba 3</th><th>MAX</th><th>%MC</th>`;
    }

    html+=`</tr></thead><tbody>`;

    list.forEach((a,i)=>{
      html+=`<tr>
        <td>${i+1}</td>
        <td>${a.zawodnik}</td>
        <td>${a.klub||"-"}</td>
        <td>${a.waga||"-"}</td>`;

      if(/TIEBREAK/i.test(comp)){
        html+=`<td>${a.wynik}</td>`;
      }
      else if(/SN/i.test(comp)){
        html+=`<td>${a.odciezar}</td><td>${a.powtorzenia}</td><td>${a.wynik}</td>`;
      }
      else {
        const p = a.proby.sort((x,y)=>x.nr-y.nr).map(x=>x.val);
        html+=`
          <td>${p[0]||"-"}</td>
          <td>${p[1]||"-"}</td>
          <td>${p[2]||"-"}</td>
          <td>${a.max}</td>
          <td>${(a.pct*100).toFixed(2)}%</td>`;
      }

      html+=`</tr>`;
    });

    html+=`</tbody></table>`;
    box.insertAdjacentHTML("beforeend",html);
  });
}

/* ================= FILTER ================= */
document.getElementById("filterInput").addEventListener("input",e=>{
  const q = norm(e.target.value);
  document.querySelectorAll("#generalka tbody tr, #boje tbody tr").forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

/* ================= SERVICE WORKER ================= */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
window.addEventListener("pageshow",e=>{
  if(e.persisted){
    document.getElementById("loader").style.display="none";
    document.getElementById("content").style.display="block";
  }
});
</script>

</body>
</html>
